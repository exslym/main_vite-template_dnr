<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="#" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" />

    <!-- название текущей страницы -->
    <title data-title="pageTitle">TITLE</title>

    <!-- for GOOGLE ANALYTICS -->
    <!-- MAIN_PAGE - название текущей страницы, если это многостраничный сайт, то на следующих страницах после главной можно указать, например, PAGE_1, PAGE_2 и т.д., нужно для GA -->

    <meta name="pageTitleGAEvents" content="MAIN_PAGE" />
    <script type="text/javascript">
      const pageTitleGA = `${document.querySelector('meta[name="pageTitleGAEvents"]').content}`;
      const pageTitle = `${document.querySelector('[data-title="pageTitle"]').textContent}`;
    </script>

    <!-- GOOGLE ANALYTICS (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=X-XXXXXXXXXX"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      // здесь вместо X-XXXXXXXXXX - идентификатор потока данных счетчика GA4
      gtag('js', new Date());
      gtag('config', 'X-XXXXXXXXXX');

      // здесь вместо __полный_адрес_страницы__ - актуальный полный адрес (включая домен) страницы на платформе doktornarabote.ru, например: https://www.doktornarabote.ru/page/1002020.
      // для многостраничного сайта: главная (стартовая страница - index.html) - просто прямой путь, например: https://www.doktornarabote.ru/page/1002020, остальные страницы (page1.html, page2.html, ...): с добавлением hash, например: https://www.doktornarabote.ru/page/1002020#page1 и т.д.
      gtag('set', {
        page_title: `${pageTitle}`,
        page_location: '__полный_адрес_страницы__',
      });
    </script>

    <!-- GOOGLE ANALYTICS DocId -->
    <script>
      window.addEventListener('load', () => {
        window.addEventListener('message', (e) => {
          if (e.data.docData) gtag(`event`, `UserID`, { DocId: e.data.docData.Id });
        });
      });
    </script>

    <!-- GOOGLE TAG MANAGER (GTM) -->
    <script type="text/javascript">
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
          'gtm.start': new Date().getTime(),
          event: 'gtm.js',
        });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
        // здесь вместо XXX-XXXXXXX идентификатор потока данных счетчика GTM
      })(window, document, 'script', 'dataLayer', 'XXX-XXXXXXX');
    </script>

    <!-- GOOGLE ANALYTICS SEND EVENTS FUNCTION -->
    <script type="text/javascript">
      const sendGTAG = (eventName, property, label) => {
        let eventProperty = new Object();
        eventProperty = { [property]: label };
        if (typeof gtag === 'function') {
          gtag(`event`, eventName, eventProperty);
        } else {
          console.log(`event`, eventName, eventProperty);
        }
      };
    </script>

    <!-- GOOGLE ANALYTICS NOBOUNCE -->
    <script type="text/javascript">
      window.addEventListener('load', () => {
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 5 seconds`);',
          5000,
        );
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 10 seconds`);',
          10000,
        );
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 15 seconds`);',
          15000,
        );
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 20 seconds`);',
          20000,
        );
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 30 seconds`);',
          30000,
        );
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 40 seconds`);',
          40000,
        );
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 1 minute`);',
          60000,
        );
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 2 minutes`);',
          120000,
        );
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 3 minutes`);',
          180000,
        );
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 5 minutes`);',
          300000,
        );
        setTimeout(
          'sendGTAG(`NoBounce_${pageTitleGA}`, `time_${pageTitleGA}`, `Over 10 minutes`);',
          600000,
        );
      });
    </script>

    <!-- GOOGLE ANALYTICS PAGE SCROLL -->
    <script src="tools/scroll-tracker.min.js"></script>
    <script type="text/javascript">
      window.addEventListener('load', () => {
        let tracker = window.ScrollTracker({ context: document.querySelector('body') });
        tracker.on({ percentages: { every: [10] } }, (e) => {
          const eventName = `Scroll_${pageTitleGA}`;
          const property = `Scroll_${pageTitleGA}`;
          const label = `${e.data.label}`;
          sendGTAG(eventName, property, label);
        });
      });
    </script>

    <!-- GOOGLE ANALYTICS SLIDES VIEWS -->
    <script type="text/javascript">
      window.addEventListener('load', () => {
        const slideObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach(({ isIntersecting, target }) => {
              if (!isIntersecting) return;
              target.classList.add('_visited');
              const eventName = `Slides_${pageTitleGA}`;
              const property = `Slides_${pageTitleGA}`;
              const label = `${target.id}`;
              sendGTAG(eventName, property, label);
            });
          },
          { threshold: 0.1 },
        );
        const slides = document.querySelectorAll('[data-id="slidesObserver"]');
        slides.forEach((slide) => slideObserver.observe(slide));
      });
    </script>
  </head>

  <body>
    <div class="wrapper">
      <section class="section _1" data-id="slidesObserver" id="screen_1">
        <div class="section__content">
          <div class="content"></div>
        </div>
      </section>
    </div>

    <!-- GOOGLE ANALYTICS VIDEO VIEWS -->
    <script type="text/javascript">
      (function (e) {
        const matches =
          e.matches ||
          e.matchesSelector ||
          e.webkitMatchesSelector ||
          e.mozMatchesSelector ||
          e.msMatchesSelector ||
          e.oMatchesSelector;
        !matches
          ? (e.matches = e.matchesSelector =
              function matches(selector) {
                const matches = document.querySelectorAll(selector);
                const th = this;
                return Array.prototype.some.call(matches, function (e) {
                  return e === th;
                });
              })
          : (e.matches = e.matchesSelector = matches);
      })(Element.prototype);
      (function (e) {
        e.closest =
          e.closest ||
          function (css) {
            const node = this;
            while (node) {
              if (node.matches(css)) return node;
              else node = node.parentElement;
            }
            return null;
          };
      })(Element.prototype);
      const videos = document.querySelectorAll('video');
      const eventName = `Video_${pageTitleGA}`;
      const property = `Video_${pageTitleGA}`;

      videos.forEach((video) => {
        let timer = null;
        let sec = 0;
        const startTimer = function startTimer() {
          return setInterval(function () {
            const seconds = sec + 1;
            const minutes = Math.floor(seconds / 60);
            const durationReal = Math.floor(video.duration);
            // Конец видео (продолжительность видео минус 5 секунд, можно задать точнее, например, за 1 секунду до конца)
            const duration = durationReal - 5;
            const data = video.dataset.label;

            // GOOGLE ANALYTICS:
            //
            // Старт видео (с 1 секунды):
            switch (true) {
              case seconds === 1:
                sendGTAG(eventName, property, `${data} - start`);
                break;
              case seconds > 0 && seconds < 30:
                if (seconds % 5 === 0) {
                  sendGTAG(eventName, property, `${data} - ${seconds}s`);
                }
                break;
              case seconds >= 30 && seconds < 60:
                if (seconds % 15 === 0) {
                  sendGTAG(eventName, property, `${data} - ${seconds}s`);
                }
                break;
              // после первых 60 секунд конвертим секунды в минуты и каждые 15 секунд опрокидываем событие вида, например, 1m 45s, далее 2m, далее 2m 15s и т.д.:
              case seconds >= 60 && seconds < duration:
                if (seconds % 15 === 0) {
                  switch (true) {
                    case seconds - minutes * 60 !== 0:
                      sendGTAG(
                        eventName,
                        property,
                        `${data} - ${minutes}m ${seconds - minutes * 60}s`,
                      );
                      break;
                    default:
                      sendGTAG(eventName, property, `${data} - ${minutes}m`);
                      break;
                  }
                }
                break;
              // Конец видео:
              case seconds === duration:
                sendGTAG(eventName, property, `${data} - end`);
                break;
            }
            sec++;
          }, 1000);
        };

        const stopTimer = () => {
          clearInterval(timer);
        };
        video.addEventListener('play', () => {
          timer = startTimer();
        });
        video.addEventListener('pause', () => {
          stopTimer();
        });
      });
    </script>

    <!-- Google Tag Manager (GTM) -->
    <!-- здесь вместо XXX-XXXXXXX идентификатор потока данных счетчика GTM  -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=XXX-XXXXXXX"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      >
      </iframe>
    </noscript>
  </body>
</html>
